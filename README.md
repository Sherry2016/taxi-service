# Taxi Service
This service provides an API for a taxi service web app so that clients can submit ride requests with their proposed prices, 
and fleets can view these requests and make bids to rides.

## Getting Started
### Dependencies

`docker v25`
`node v21`

### Environment Setup

An `.env` file is already created for demo purpose which includes all the necessary environment variables to run the application locally

### Building and running the application in docker

First start Docker Desktop.

Then start the application in docker by running:
`npm run docker`.

It'll start both the MongoDB and the service docker container.
The application will be available at http://localhost:3000.

### Stop the application and remove the database volume, containers, and images
`npm run stop-and-clean`

### Run tests

`npm run test`

### Develop locally

Run the MongoDB docker container by `npm run db`.

Run the server locally by `npm install && npm run start`

## API Reference

The base URL for the API is http://localhost:3000/api. 

### Request a ride

Allow clients to request a ride by providing details such as pickup location, drop-off location, and their proposed price.

`POST /rides`

Payload type:
```json
{
  "clientId": "[string, required]",
  "pickupLocation": "[string, required]",
  "dropoffLocation": "[string, required]",
  "proposedPrice": "[number, required]"
}
```

Example request:

```bash
curl -X POST -H "Content-Type: application/json" -d '{"clientId": "client5", "pickupLocation": "111 Pickup St",
"dropoffLocation": "222 Drop off St", "proposedPrice": 30}' http://localhost:3000/api/rides
```

Example success response:

`Status code: 201 Created`
```json
{
  "_id": "65ca1fdf60043c23701b27b1"
}
```

The `_id` in the response is automatically generated by MongoDB as a unique identifier for the created ride.

Example error response:

`Status code: 400 Bad request`
```json
{"error":"\"pickupLocation\" is required"}
```


#### Make bid on ride
Allow fleets to place bids on a specific ride request

`POST /rides/$RIDEID/bids`

Replace the `$RIDEID` with a valid ride `_id` from the responses from above requests.

Payload type:
```json
{
  "fleetId": "[string, required]",
  "bidAmount": "[number, required]"
}
```

Example request:

```bash
curl -X POST -H "Content-Type: application/json" -d '{"fleetId": "fleet5", "bidAmount": 30}' http://localhost:3000/api/rides/65cc831aa4326d4c911a3a22/bids
```

Example success response:

`Status code: 200 OK`

Example error response:

`Status code: 400 Bad request`
```json
{"error":"\"fleetId\" is required"}
```

#### View Ride Requests
Allow fleets to view a list of ride requests from clients, including details like pickup/drop-off locations, date-time and proposed prices.

`GET /rides`

Example request:

```bash
curl http://localhost:3000/api/rides
```

Example success response:

`Status code: 200 OK`
```json
[
  {
    "_id": "65cdf9248931050d915d3ee5",
    "pickupLocation": "123 Main St",
    "dropoffLocation": "456 Elm St",
    "proposedPrice": 20,
    "createdAt": "2024-02-15T11:45:10.519Z"
  },
  {
    "_id": "65cdf9248931050d915d3ee6",
    "pickupLocation": "789 Oak St",
    "dropoffLocation": "101 Pine St",
    "proposedPrice": 25,
    "createdAt": "2024-02-15T11:45:10.520Z"
  },
  {
    "_id": "65cdf9248931050d915d3ee7",
    "pickupLocation": "456 Elm St",
    "dropoffLocation": "789 Oak St",
    "proposedPrice": 18,
    "createdAt": "2024-02-15T11:45:10.521Z"
  },
  {
    "_id": "65cdf9248931050d915d3ee8",
    "pickupLocation": "101 Pine St",
    "dropoffLocation": "123 Main St",
    "proposedPrice": 30,
    "createdAt": "2024-02-15T11:45:10.521Z"
  }
]
```

#### View Bids on Ride
Allow clients to view bids received for their requested ride.

`GET /rides/$RIDEID/bids`

Replace the `$RIDEID` with a valid ride `_id` from the response from above requests.

Example request:

```bash
curl http://localhost:3000/api/rides/65ca1fdf60043c23701b27b1/bids
```

Example success response:

`Status code: 200 OK`
```json
[
  {
    "fleetId": "fleet5",
    "bidAmount": 30,
    "_id": "65cdf9d680bb9811a7aeb9e4"
  },
  {
    "fleetId": "fleet6",
    "bidAmount": 20,
    "_id": "65cdfbeb80bb9811a7aeb9e9"
  }
]
```

Error response:

`Status code: 404 Not found`
```json
{
  "error": "The ride is not found"
}
```

## IAC solution

The repo contains a simple Terraform solution to provision a Google Cloud Run service to host the dockerized api service, 
and to provision a MongoDB Atlas database on GCP.

### Prerequisites
- Terraform v1.5.0+

Fake credentials are provided as placeholders in [variables.tf](terraform%2Fvariables.tf) and [.google-account-credentials.json](.google-account-credentials.json)
for demo purpose. Run the following commands to see the execution plan.

```bash 
cd terraform
terraform init
terraform plan
```

Valid credentials obtained from GCP Account, MongoDB Atlas Account and a valid container image url need to be used to apply the infrastructure change.

### Considerations
- Secrets management

    Once MongoDB is provisioned, the production database URL needs to be updated in the container env potentially through Google Secret Manager

- Network configs and access control
    
    In initial stages there is no network restriction for the database and there is no auth on accessing the service.

- Terraform state file
    
    Terraform state files should be saved separately, for example on a Cloud Storage bucket created beforehand
